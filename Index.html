<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حلّاق الأسئلة الذكي</title>
    <!-- Tailwind + Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- الخط و التنسيق -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        *{font-family:'Tajawal',sans-serif}
        body{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);min-height:100vh}
        /* ============ المظهر الزجاجي ============ */
        .glass-morphism{background:rgba(255,255,255,.15);backdrop-filter:blur(10px);border-radius:20px;
            border:1px solid rgba(255,255,255,.2);box-shadow:0 8px 32px rgba(0,0,0,.1)}
        /* ============ الكاميرا ============ */
        .camera-container{position:relative;overflow:hidden;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
        .camera-overlay{position:absolute;inset:0;background:rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center;pointer-events:none;z-index:10}
        
        /* مناطق الاستخراج الثابتة */
        .question-region {
            position: absolute;
            top: 10%;
            left: 5%;
            width: 90%;
            height: 12%;
            border: 3px solid #ef4444;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.7);
            z-index: 20;
            transition: all 0.3s ease;
        }
        
        .options-region {
            position: absolute;
            top: 30%;
            left: 5%;
            width: 90%;
            height: 45%;
            border: 3px solid #22c55e;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(34, 197, 94, 0.7);
            z-index: 20;
            transition: all 0.3s ease;
        }
        
        .region-label {
            position: absolute;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .question-label {
            top: -25px;
            right: 0;
            background: #ef4444;
        }
        
        .options-label {
            top: -25px;
            right: 0;
            background: #22c55e;
        }
        
        /* ============ بطاقات الإجابة ============ */
        .answer-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border-radius:15px;padding:20px;color:#fff;
            box-shadow:0 10px 25px rgba(0,0,0,.2);transform:translateY(20px);opacity:0;transition:.5s}
        .answer-card.show{transform:translateY(0);opacity:1}
        /* ============ منطقة الرفع ============ */
        .upload-area{border:2px dashed rgba(255,255,255,.5);border-radius:15px;padding:40px;text-align:center;
            transition:.3s;cursor:pointer}
        .upload-area:hover{border-color:#4ade80;background:rgba(74,222,128,.1)}
        .upload-area.dragover{border-color:#4ade80;background:rgba(74,222,128,.2)}
        /* ============ الأزرار ============ */
        .btn-primary{background:linear-gradient(135deg,#4ade80 0%,#22c55e 100%);color:#fff;padding:12px 30px;border-radius:50px;
            font-weight:600;transition:.3s;box-shadow:0 4px 15px rgba(74,222,128,.4)}
        .btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(74,222,128,.6)}
        .btn-secondary{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:#fff;padding:12px 30px;border-radius:50px;
            font-weight:600;transition:.3s;box-shadow:0 4px 15px rgba(245,158,11,.4)}
        .btn-secondary:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(245,158,11,.6)}
        .btn-rescan{background:linear-gradient(135deg,#a29bfe 0%,#6c5ce7 100%);color:#fff;padding:12px 30px;border-radius:50px;
            font-weight:600;transition:.3s;box-shadow:0 4px 15px rgba(108,92,231,.4)}
        .btn-rescan:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(108,92,231,.6)}
        /* تبويبات */
        .tab-active{background:rgba(255,255,255,.2);border-bottom:3px solid #4ade80}
        /* محمل دائري */
        .loading-spinner{border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top:3px solid #4ade80;width:40px;height:40px;
            animation:spin 1s linear infinite;margin:20px auto}
        @keyframes spin{to{transform:rotate(360deg)}}
        /* تأثير دخول */
        .fade-in{animation:fadeIn .5s}@keyframes fadeIn{from{opacity:0}to{opacity:1}}
        /* نمط الخيارات */
        .option-box {
            background: rgba(255, 255, 255, 0.9);
            color: #1e293b;
            border-radius: 12px;
            padding: 16px;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .option-box.correct {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: white;
            transform: scale(1.05);
            box-shadow: 0 8px 15px rgba(245, 158, 11, 0.4);
        }
        /* نمط لوحة التحكم */
        .control-panel {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .control-group {
            margin-bottom: 10px;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .control-group input[type="range"] {
            width: 100%;
        }
        .control-value {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 5px;
        }
        .control-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .control-buttons button {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            font-size: 14px;
        }
        /* نمط لوحة معالجة الصورة */
        .image-processing-panel {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .processing-option {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .processing-option input[type="checkbox"] {
            margin-left: 10px;
        }
        .processing-option label {
            flex: 1;
            font-size: 14px;
        }
        .processing-preview {
            margin-top: 15px;
            text-align: center;
        }
        .processing-preview img {
            max-width: 100%;
            border-radius: 8px;
            max-height: 200px;
        }
        
        /* ============ الأيقونة العائمة ============ */
        .floating-icon {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 8px 25px rgba(74, 222, 128, 0.5);
            cursor: pointer;
            z-index: 9999;
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
        }
        
        .floating-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 30px rgba(74, 222, 128, 0.7);
        }
        
        .floating-icon i {
            font-size: 30px;
            color: white;
        }
        
        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7);
            }
            70% {
                box-shadow: 0 0 0 15px rgba(74, 222, 128, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(74, 222, 128, 0);
            }
        }
        
        /* ============ نافذة الإجابة السريعة ============ */
        .quick-answer-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 20px;
            padding: 25px;
            max-width: 90%;
            width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .quick-answer-modal.active {
            transform: translate(-50%, -50%) scale(1);
            opacity: 1;
            visibility: visible;
        }
        
        .quick-answer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .quick-answer-title {
            font-size: 20px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
        }
        
        .quick-answer-title i {
            margin-left: 10px;
            color: #4ade80;
        }
        
        .quick-answer-close {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: white;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .quick-answer-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }
        
        .quick-answer-content {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .quick-answer-text {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            color: #4ade80;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .quick-answer-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .quick-answer-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .quick-answer-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quick-answer-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        /* ============ لوحة حالة الأذونات ============ */
        .permission-panel {
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .permission-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .permission-item:last-child {
            border-bottom: none;
        }
        
        .permission-info {
            flex: 1;
        }
        
        .permission-name {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .permission-desc {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .permission-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }
        
        .status-granted {
            background: #4ade80;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }
        
        .status-denied {
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        .status-pending {
            background: #f59e0b;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }
        
        .request-permission-btn {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .request-permission-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 222, 128, 0.4);
        }
        
        .request-permission-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* ============ لوحة الإرشادات ============ */
        .instructions-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .instructions-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4ade80;
        }
        
        .instruction-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .step-number {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-left: 12px;
            flex-shrink: 0;
        }
        
        .step-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* ============ رسالة الخطأ المحسنة ============ */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: flex-start;
        }
        
        .error-icon {
            color: #ef4444;
            font-size: 20px;
            margin-left: 10px;
            flex-shrink: 0;
        }
        
        .error-content {
            flex: 1;
        }
        
        .error-title {
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .error-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .error-actions {
            margin-top: 10px;
        }
        
        .error-action-btn {
            background: rgba(239, 68, 68, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.3s ease;
        }
        
        .error-action-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }
        
        /* ============ رسالة تحذير الملف المحلي ============ */
        .local-file-warning {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .warning-icon {
            font-size: 48px;
            color: #f59e0b;
            margin-bottom: 15px;
        }
        
        .warning-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #f59e0b;
        }
        
        .warning-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }
        
        .solution-steps {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            text-align: right;
        }
        
        .solution-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #4ade80;
        }
        
        .solution-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .solution-number {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-left: 10px;
            flex-shrink: 0;
            font-size: 12px;
        }
        
        .solution-text {
            flex: 1;
            font-size: 14px;
        }
        
        .code-block {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            padding: 5px 10px;
            font-family: monospace;
            font-size: 13px;
            margin: 5px 0;
        }
        
        /* ============ شريط التقدم ============ */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(74, 222, 128, 0.3);
            z-index: 10002;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .progress-bar.active {
            opacity: 1;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
        }
        
        /* ============ تأثيرات النجاح ============ */
        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 100px;
            height: 100px;
            background: rgba(74, 222, 128, 0.2);
            border-radius: 50%;
            z-index: 10003;
            opacity: 0;
            pointer-events: none;
        }
        
        .success-animation.active {
            animation: successPulse 0.6s ease-out;
        }
        
        @keyframes successPulse {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(3);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="text-white">
    <div class="container mx-auto px-4 py-8">
        <!-- ================= رأس الصفحة ================= -->
        <header class="text-center mb-10 fade-in">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">
                <i class="fas fa-brain text-yellow-400 mr-3"></i> حلّاق الأسئلة الذكي
            </h1>
            <p class="text-xl text-blue-200 max-w-2xl mx-auto">
                حل أسئلة الاختيار من متعدد بشكل مباشر باستخدام الكاميرا أو رفع الصور
            </p>
        </header>
        
        <!-- رسالة تحذير الملف المحلي -->
        <div id="local-file-warning" class="local-file-warning hidden">
            <i class="fas fa-exclamation-triangle warning-icon"></i>
            <h2 class="warning-title">تحذير: يتم تشغيل الملف محلياً</h2>
            <p class="warning-text">
                أنت تشغل هذا التطبيق مباشرة من ملف محلي (file://). هذا يمنع الوصول إلى ميزات مهمة مثل الكاميرا والتقاط الشاشة في Google Chrome.
            </p>
            
            <div class="solution-steps">
                <h3 class="solution-title"><i class="fas fa-lightbulb mr-2"></i>كيفية حل المشكلة:</h3>
                
                <div class="solution-step">
                    <div class="solution-number">1</div>
                    <div class="solution-text">استخدم VS Code مع امتداد Live Server</div>
                </div>
                
                <div class="solution-step">
                    <div class="solution-number">2</div>
                    <div class="solution-text">افتح terminal في مجلد الملف واكتب:</div>
                </div>
                <div class="code-block">python -m http.server 8000</div>
                <div class="code-block">ثم افتح http://localhost:8000 في المتصفح</div>
                
                <div class="solution-step">
                    <div class="solution-number">3</div>
                    <div class="solution-text">أو استخدم Node.js:</div>
                </div>
                <div class="code-block">npm install -g http-server</div>
                <div class="code-block">http-server</div>
            </div>
        </div>
        
        <!-- ================= المحتوى ================= -->
        <main class="max-w-4xl mx-auto">
            <!-- التبويبات -->
            <div class="flex mb-6 bg-white bg-opacity-10 rounded-xl p-1">
                <button id="camera-tab" class="flex-1 py-3 px-4 rounded-lg text-center font-medium tab-active"
                        onclick="switchTab('camera')"><i class="fas fa-camera mr-2"></i> الكاميرا المباشرة</button>
                <button id="upload-tab" class="flex-1 py-3 px-4 rounded-lg text-center font-medium"
                        onclick="switchTab('upload')"><i class="fas fa-upload mr-2"></i> رفع الملفات</button>
                <button id="screen-tab" class="flex-1 py-3 px-4 rounded-lg text-center font-medium"
                        onclick="switchTab('screen')"><i class="fas fa-desktop mr-2"></i> التقاط الشاشة</button>
            </div>
            <!-- ========== تبويب الكاميرا ========== -->
            <div id="camera-content" class="glass-morphism p-6 rounded-2xl">
                <div class="mb-6 text-center">
                    <h2 class="text-2xl font-bold mb-2">الكاميرا المباشرة</h2>
                    <p class="text-blue-200">وجّه الكاميرا نحو السؤال ثم اضغط على "مسح السؤال"</p>
                </div>
                
                <!-- لوحة التحكم بالأبعاد -->
                <div class="control-panel">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- تحكم منطقة السؤال -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-red-300">منطقة السؤال</h3>
                            <div class="control-group">
                                <label>الموضع العلوي (Top): <span class="control-value" id="q-top-value">10%</span></label>
                                <input type="range" id="q-top" min="0" max="50" value="10" step="1" onchange="updateRegionDimensions()">
                            </div>
                            <div class="control-group">
                                <label>المسافة من اليسار (Left): <span class="control-value" id="q-left-value">5%</span></label>
                                <input type="range" id="q-left" min="0" max="50" value="5" step="1" onchange="updateRegionDimensions()">
                            </div>
                            <div class="control-group">
                                <label>العرض (Width): <span class="control-value" id="q-width-value">90%</span></label>
                                <input type="range" id="q-width" min="20" max="95" value="90" step="1" onchange="updateRegionDimensions()">
                            </div>
                            <div class="control-group">
                                <label>الارتفاع (Height): <span class="control-value" id="q-height-value">12%</span></label>
                                <input type="range" id="q-height" min="5" max="40" value="12" step="1" onchange="updateRegionDimensions()">
                            </div>
                        </div>
                        
                        <!-- تحكم منطقة الخيارات -->
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-green-300">منطقة الخيارات</h3>
                            <div class="control-group">
                                <label>الموضع العلوي (Top): <span class="control-value" id="o-top-value">30%</span></label>
                                <input type="range" id="o-top" min="10" max="70" value="30" step="1" onchange="updateRegionDimensions()">
                            </div>
                            <div class="control-group">
                                <label>المسافة من اليسار (Left): <span class="control-value" id="o-left-value">5%</span></label>
                                <input type="range" id="o-left" min="0" max="50" value="5" step="1" onchange="updateRegionDimensions()">
                            </div>
                            <div class="control-group">
                                <label>العرض (Width): <span class="control-value" id="o-width-value">90%</span></label>
                                <input type="range" id="o-width" min="20" max="95" value="90" step="1" onchange="updateRegionDimensions()">
                            </div>
                            <div class="control-group">
                                <label>الارتفاع (Height): <span class="control-value" id="o-height-value">45%</span></label>
                                <input type="range" id="o-height" min="10" max="70" value="45" step="1" onchange="updateRegionDimensions()">
                            </div>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="bg-blue-600 hover:bg-blue-700" onclick="resetToDefaults()">
                            <i class="fas fa-undo mr-1"></i> استعادة الافتراضي
                        </button>
                        <button class="bg-purple-600 hover:bg-purple-700" onclick="saveDimensions()">
                            <i class="fas fa-save mr-1"></i> حفظ الإعدادات
                        </button>
                    </div>
                </div>
                
                <!-- لوحة معالجة الصورة -->
                <div class="image-processing-panel">
                    <h3 class="text-lg font-semibold mb-3 text-yellow-300">تحسين جودة الصورة</h3>
                    <div class="processing-option">
                        <input type="checkbox" id="grayscale" checked>
                        <label for="grayscale">تحويل إلى أبيض وأسود (للصور الرصادية)</label>
                    </div>
                    <div class="processing-option">
                        <input type="checkbox" id="enhance-contrast" checked>
                        <label for="enhance-contrast">زيادة التباين</label>
                    </div>
                    <div class="processing-option">
                        <input type="checkbox" id="sharpen-image" checked>
                        <label for="sharpen-image">توضيح الصورة</label>
                    </div>
                    <div class="processing-option">
                        <input type="checkbox" id="remove-noise">
                        <label for="remove-noise">إزالة الضوضاء</label>
                    </div>
                    <div class="processing-option">
                        <input type="checkbox" id="increase-resolution">
                        <label for="increase-resolution">زيادة الدقة</label>
                    </div>
                    <div class="processing-option">
                        <input type="checkbox" id="auto-rotate">
                        <label for="auto-rotate">تصحيح الاتجاه تلقائياً</label>
                    </div>
                </div>
                
                <div class="camera-container mb-6">
                    <video id="camera-feed" class="w-full h-auto rounded-xl" autoplay playsinline></video>
                    <div class="camera-overlay">
                        <!-- منطقة السؤال -->
                        <div class="question-region" id="question-region">
                            <div class="region-label question-label">منطقة السؤال</div>
                        </div>
                        <!-- منطقة الخيارات -->
                        <div class="options-region" id="options-region">
                            <div class="region-label options-label">منطقة الخيارات</div>
                        </div>
                    </div>
                </div>
                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="start-camera" class="btn-primary" onclick="startCamera()">
                        <i class="fas fa-play mr-2"></i> بدء الكاميرا
                    </button>
                    <button id="scan-btn" class="btn-rescan hidden" onclick="scanQuestion()">
                        <i class="fas fa-camera mr-2"></i> مسح السؤال
                    </button>
                    <button id="stop-camera" class="btn-secondary hidden" onclick="stopCamera()">
                        <i class="fas fa-stop mr-2"></i> إيقاف الكاميرا
                    </button>
                </div>
                <div id="camera-status" class="mt-6 text-center text-blue-200"></div>
            </div>
            <!-- ========== تبويب الرفع ========== -->
            <div id="upload-content" class="glass-morphism p-6 rounded-2xl hidden">
                <div class="mb-6 text-center">
                    <h2 class="text-2xl font-bold mb-2">رفع صورة السؤال</h2>
                    <p class="text-blue-200">اختر صورة تحتوي على سؤال الاختيار من متعدد</p>
                </div>
                <div id="upload-area" class="upload-area mb-6"
                     onclick="document.getElementById('file-input').click()">
                    <i class="fas fa-cloud-upload-alt text-5xl text-blue-300 mb-4"></i>
                    <h3 class="text-xl font-semibold mb-2">اسحب الصورة هنا أو اضغط للاختيار</h3>
                    <p class="text-blue-200">PNG, JPG, JPEG حتى 5MB</p>
                    <input type="file" id="file-input" class="hidden" accept="image/*"
                           onchange="handleFileUpload(event)">
                </div>
                <div id="upload-preview" class="hidden mb-6">
                    <img id="preview-image" class="w-full rounded-xl shadow-lg" alt="Preview">
                    <!-- مناطق الاستخراج للصورة المرفوعة -->
                    <div class="relative mt-4">
                        <div class="question-region" id="upload-question-region">
                            <div class="region-label question-label">منطقة السؤال</div>
                        </div>
                        <div class="options-region" id="upload-options-region">
                            <div class="region-label options-label">منطقة الخيارات</div>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <button id="solve-btn" class="btn-primary hidden" onclick="solveUploadedQuestion()">
                        <i class="fas fa-magic mr-2"></i> حل السؤال
                    </button>
                </div>
                <div id="upload-status" class="mt-6 text-center text-blue-200"></div>
            </div>
            <!-- ========== تبويب التقاط الشاشة ========== -->
            <div id="screen-content" class="glass-morphism p-6 rounded-2xl hidden">
                <div class="mb-6 text-center">
                    <h2 class="text-2xl font-bold mb-2">التقاط الشاشة</h2>
                    <p class="text-blue-200">التقط أي سؤال يظهر على شاشتك واحصل على الإجابة فوراً</p>
                </div>
                
                <!-- لوحة حالة الأذونات -->
                <div class="permission-panel">
                    <h3 class="text-lg font-semibold mb-4 text-center">حالة الأذونات المطلوبة</h3>
                    
                    <div class="permission-item">
                        <div class="permission-info">
                            <div class="permission-name">التقاط الشاشة</div>
                            <div class="permission-desc">مطلوب لالتقاط صورة من شاشتك</div>
                        </div>
                        <div class="permission-status">
                            <span class="status-indicator" id="screen-permission-indicator"></span>
                            <span id="screen-permission-text">لم يتم التحقق</span>
                            <button class="request-permission-btn" id="request-screen-btn" onclick="requestScreenPermission()">
                                طلب الإذن
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- لوحة الإرشادات -->
                <div class="instructions-panel">
                    <h3 class="instructions-title">كيفية منح إذن التقاط الشاشة</h3>
                    
                    <div class="instruction-step">
                        <div class="step-number">1</div>
                        <div class="step-text">اضغط على زر "طلب الإذن" أعلاه</div>
                    </div>
                    
                    <div class="instruction-step">
                        <div class="step-number">2</div>
                        <div class="step-text">سيظهر لك مربع حوار يطلب منك اختيار ما تريد التقاطه</div>
                    </div>
                    
                    <div class="instruction-step">
                        <div class="step-number">3</div>
                        <div class="step-text">اختر "شاشة كاملة" أو "نافذة محددة" ثم اضغط على "مشاركة"</div>
                    </div>
                    
                    <div class="instruction-step">
                        <div class="step-number">4</div>
                        <div class="step-text">إذا تم رفض الإذن، اذهب إلى إعدادات المتصفح > إعدادات الموقع > التقاط الشاشة وغيره إلى "السماح"</div>
                    </div>
                </div>
                
                <!-- رسالة الخطأ -->
                <div id="screen-error-message" class="error-message hidden">
                    <i class="fas fa-exclamation-circle error-icon"></i>
                    <div class="error-content">
                        <div class="error-title">لا يمكن الوصول إلى ميزة التقاط الشاشة</div>
                        <div class="error-description">
                            قد يكون متصفحك لا يدعم هذه الميزة أو تم رفض الإذن. يرجى التحقق من إعدادات المتصفح والمحاولة مرة أخرى.
                        </div>
                        <div class="error-actions">
                            <button class="error-action-btn" onclick="checkScreenPermission()">التحقق مرة أخرى</button>
                            <button class="error-action-btn" onclick="openBrowserSettings()">فتح إعدادات المتصفح</button>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="start-screen-capture" class="btn-primary" onclick="startScreenCapture()" disabled>
                        <i class="fas fa-desktop mr-2"></i> بدء التقاط الشاشة
                    </button>
                </div>
                
                <div id="screen-status" class="mt-6 text-center text-blue-200"></div>
            </div>
            <!-- ========== الإجابة ========== -->
            <div id="answer-section" class="mt-8 hidden">
                <div class="answer-card">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-2xl font-bold">
                            <i class="fas fa-lightbulb text-yellow-300 mr-2"></i> الإجابة المقترحة
                        </h3>
                        <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm">دقة تقريبية</span>
                    </div>
                    <div id="answer-content" class="text-lg mb-4"></div>
                    <div class="flex justify-between items-center">
                        <button class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all"
                                onclick="copyAnswer()"><i class="fas fa-copy mr-2"></i> نسخ الإجابة</button>
                        <button class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all"
                                onclick="shareAnswer()"><i class="fas fa-share-alt mr-2"></i> مشاركة</button>
                        <button class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-all"
                                onclick="resetAnswer()"><i class="fas fa-redo mr-2"></i> مسح الإجابة</button>
                    </div>
                </div>
            </div>
        </main>
        <!-- ================= التذييل ================= -->
        <footer class="text-center mt-16 text-blue-200">
            <p>© <span id="year"></span> حلّاق الأسئلة الذكي - جميع الحقوق محفوظة</p>
            <p class="mt-2 text-sm">يعمل بالكامل في متصفحك بدون اتصال بالإنترنت</p>
        </footer>
    </div>
    
    <!-- ============ الأيقونة العائمة ============ -->
    <div class="floating-icon" id="floating-icon" onclick="quickScreenCapture()">
        <i class="fas fa-magic"></i>
    </div>
    
    <!-- ============ نافذة الإجابة السريعة ============ -->
    <div class="quick-answer-modal" id="quick-answer-modal">
        <div class="quick-answer-header">
            <h3 class="quick-answer-title">
                <i class="fas fa-lightbulb"></i>
                الإجابة السريعة
            </h3>
            <button class="quick-answer-close" onclick="closeQuickAnswer()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="quick-answer-content" id="quick-answer-content">
            <div class="quick-answer-loading" id="quick-answer-loading">
                <div class="loading-spinner"></div>
                <span>جاري تحليل السؤال...</span>
            </div>
            <div class="quick-answer-text" id="quick-answer-text" style="display: none;"></div>
        </div>
        
        <div class="quick-answer-actions">
            <button class="quick-answer-btn" onclick="copyQuickAnswer()">
                <i class="fas fa-copy"></i>
                نسخ
            </button>
            <button class="quick-answer-btn" onclick="closeQuickAnswer()">
                <i class="fas fa-times"></i>
                إغلاق
            </button>
        </div>
    </div>
    
    <!-- ============ شريط التقدم ============ -->
    <div class="progress-bar" id="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
    </div>
    
    <!-- ============ تأثير النجاح ============ -->
    <div class="success-animation" id="success-animation"></div>
    
    <!-- ================== JavaScript ================== -->
    <script>
        /* مفاتيح الخدمة */
        const OCR_KEY  = "K81072613988957";                 // ← مفتاح OCR Space
        const HF_TOKEN = "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"; // ← توكن HuggingFace
        /* متغيرات عامة */
        let cameraStream = null, currentAnswer = "", screenStream = null;
        let screenPermissionGranted = false;
        let isLocalFile = false;
        let quickAnswerTimeout = null;
        
        /* أدوات مساعدة */
        function fileToBase64(file){
            return new Promise(res=>{const r=new FileReader();r.onload=()=>res(r.result.split(',')[1]);r.readAsDataURL(file);});
        }
        function captureFrame(video){
            const c=document.createElement('canvas'); c.width=video.videoWidth||1280; c.height=video.videoHeight||720;
            c.getContext('2d').drawImage(video,0,0,c.width,c.height);
            return c.toDataURL('image/jpeg').split(',')[1];
        }
        
        // دالة لقص منطقة معينة من الصورة
        function cropImage(base64, xPercent, yPercent, widthPercent, heightPercent) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // حساب القيم الفعلية
                    const x = img.width * (xPercent / 100);
                    const y = img.height * (yPercent / 100);
                    const width = img.width * (widthPercent / 100);
                    const height = img.height * (heightPercent / 100);
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, x, y, width, height, 0, 0, width, height);
                    
                    resolve(canvas.toDataURL('image/jpeg').split(',')[1]);
                };
                img.src = 'data:image/jpeg;base64,' + base64;
            });
        }
        
        // تحسين جودة الصورة قبل معالجتها
        async function enhanceImage(base64) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // تطبيق التحسينات المحددة
                    ctx.drawImage(img, 0, 0);
                    
                    // تحويل إلى أبيض وأسود (Grayscale)
                    if (document.getElementById('grayscale').checked) {
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        
                        for (let i = 0; i < data.length; i += 4) {
                            // حساب القيمة الرمادية باستخدام الأوزان القياسية
                            const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                            data[i] = gray;     // Red
                            data[i + 1] = gray; // Green
                            data[i + 2] = gray; // Blue
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                    }
                    
                    // زيادة التباين
                    if (document.getElementById('enhance-contrast').checked) {
                        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                        const data = imageData.data;
                        const factor = 1.5; // عامل التباين
                        
                        for (let i = 0; i < data.length; i += 4) {
                            // تطبيق تعديل التباين
                            data[i] = ((data[i] - 128) * factor) + 128;     // Red
                            data[i + 1] = ((data[i + 1] - 128) * factor) + 128; // Green
                            data[i + 2] = ((data[i + 2] - 128) * factor) + 128; // Blue
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                    }
                    
                    // توضيح الصورة
                    if (document.getElementById('sharpen-image').checked) {
                        ctx.filter = 'contrast(1.2) brightness(1.1)';
                        ctx.drawImage(canvas, 0, 0);
                        ctx.filter = 'none';
                    }
                    
                    // زيادة الدقة
                    if (document.getElementById('increase-resolution').checked) {
                        const tempCanvas = document.createElement('canvas');
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        // زيادة الحجم بنسبة 50%
                        tempCanvas.width = canvas.width * 1.5;
                        tempCanvas.height = canvas.height * 1.5;
                        
                        // رسم الصورة بحجم أكبر ثم تصغيرها لتحسين الدقة
                        tempCtx.imageSmoothingEnabled = false;
                        tempCtx.drawImage(canvas, 0, 0, tempCanvas.width, tempCanvas.height);
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.imageSmoothingEnabled = true;
                        ctx.imageSmoothingQuality = 'high';
                        ctx.drawImage(tempCanvas, 0, 0, canvas.width, canvas.height);
                    }
                    
                    resolve(canvas.toDataURL('image/jpeg', 0.95).split(',')[1]);
                };
                img.src = 'data:image/jpeg;base64,' + base64;
            });
        }
        
        // تحديث أبعاد المناطق
        function updateRegionDimensions() {
            // الحصول على قيم منزلقات التحكم
            const qTop = document.getElementById('q-top').value;
            const qLeft = document.getElementById('q-left').value;
            const qWidth = document.getElementById('q-width').value;
            const qHeight = document.getElementById('q-height').value;
            
            const oTop = document.getElementById('o-top').value;
            const oLeft = document.getElementById('o-left').value;
            const oWidth = document.getElementById('o-width').value;
            const oHeight = document.getElementById('o-height').value;
            
            // تحديث القيم المعروضة
            document.getElementById('q-top-value').textContent = qTop + '%';
            document.getElementById('q-left-value').textContent = qLeft + '%';
            document.getElementById('q-width-value').textContent = qWidth + '%';
            document.getElementById('q-height-value').textContent = qHeight + '%';
            
            document.getElementById('o-top-value').textContent = oTop + '%';
            document.getElementById('o-left-value').textContent = oLeft + '%';
            document.getElementById('o-width-value').textContent = oWidth + '%';
            document.getElementById('o-height-value').textContent = oHeight + '%';
            
            // تحديث أبعاد المناطق في وضع الكاميرا
            const questionRegion = document.getElementById('question-region');
            const optionsRegion = document.getElementById('options-region');
            
            questionRegion.style.top = qTop + '%';
            questionRegion.style.left = qLeft + '%';
            questionRegion.style.width = qWidth + '%';
            questionRegion.style.height = qHeight + '%';
            
            optionsRegion.style.top = oTop + '%';
            optionsRegion.style.left = oLeft + '%';
            optionsRegion.style.width = oWidth + '%';
            optionsRegion.style.height = oHeight + '%';
            
            // تحديث أبعاد المناطق في وضع الرفع
            const uploadQuestionRegion = document.getElementById('upload-question-region');
            const uploadOptionsRegion = document.getElementById('upload-options-region');
            
            if (uploadQuestionRegion && uploadOptionsRegion) {
                uploadQuestionRegion.style.top = qTop + '%';
                uploadQuestionRegion.style.left = qLeft + '%';
                uploadQuestionRegion.style.width = qWidth + '%';
                uploadQuestionRegion.style.height = qHeight + '%';
                
                uploadOptionsRegion.style.top = oTop + '%';
                uploadOptionsRegion.style.left = oLeft + '%';
                uploadOptionsRegion.style.width = oWidth + '%';
                uploadOptionsRegion.style.height = oHeight + '%';
            }
        }
        
        // استعادة الإعدادات الافتراضية
        function resetToDefaults() {
            document.getElementById('q-top').value = 10;
            document.getElementById('q-left').value = 5;
            document.getElementById('q-width').value = 90;
            document.getElementById('q-height').value = 12;
            
            document.getElementById('o-top').value = 30;
            document.getElementById('o-left').value = 5;
            document.getElementById('o-width').value = 90;
            document.getElementById('o-height').value = 45;
            
            // إعدادات التحسين الافتراضية
            document.getElementById('grayscale').checked = true;
            document.getElementById('enhance-contrast').checked = true;
            document.getElementById('sharpen-image').checked = true;
            document.getElementById('remove-noise').checked = false;
            document.getElementById('increase-resolution').checked = false;
            document.getElementById('auto-rotate').checked = false;
            
            updateRegionDimensions();
            showNotification('تم استعادة الإعدادات الافتراضية', 'success');
        }
        
        // حفظ الإعدادات في التخزين المحلي
        function saveDimensions() {
            const dimensions = {
                qTop: document.getElementById('q-top').value,
                qLeft: document.getElementById('q-left').value,
                qWidth: document.getElementById('q-width').value,
                qHeight: document.getElementById('q-height').value,
                oTop: document.getElementById('o-top').value,
                oLeft: document.getElementById('o-left').value,
                oWidth: document.getElementById('o-width').value,
                oHeight: document.getElementById('o-height').value,
                grayscale: document.getElementById('grayscale').checked,
                enhanceContrast: document.getElementById('enhance-contrast').checked,
                sharpenImage: document.getElementById('sharpen-image').checked,
                removeNoise: document.getElementById('remove-noise').checked,
                increaseResolution: document.getElementById('increase-resolution').checked,
                autoRotate: document.getElementById('auto-rotate').checked
            };
            
            localStorage.setItem('regionDimensions', JSON.stringify(dimensions));
            showNotification('تم حفظ الإعدادات بنجاح', 'success');
        }
        
        // تحميل الإعدادات من التخزين المحلي
        function loadDimensions() {
            const savedDimensions = localStorage.getItem('regionDimensions');
            if (savedDimensions) {
                const dimensions = JSON.parse(savedDimensions);
                
                document.getElementById('q-top').value = dimensions.qTop;
                document.getElementById('q-left').value = dimensions.qLeft;
                document.getElementById('q-width').value = dimensions.qWidth;
                document.getElementById('q-height').value = dimensions.qHeight;
                
                document.getElementById('o-top').value = dimensions.oTop;
                document.getElementById('o-left').value = dimensions.oLeft;
                document.getElementById('o-width').value = dimensions.oWidth;
                document.getElementById('o-height').value = dimensions.oHeight;
                
                if (dimensions.grayscale !== undefined) {
                    document.getElementById('grayscale').checked = dimensions.grayscale;
                }
                if (dimensions.enhanceContrast !== undefined) {
                    document.getElementById('enhance-contrast').checked = dimensions.enhanceContrast;
                }
                if (dimensions.sharpenImage !== undefined) {
                    document.getElementById('sharpen-image').checked = dimensions.sharpenImage;
                }
                if (dimensions.removeNoise !== undefined) {
                    document.getElementById('remove-noise').checked = dimensions.removeNoise;
                }
                if (dimensions.increaseResolution !== undefined) {
                    document.getElementById('increase-resolution').checked = dimensions.increaseResolution;
                }
                if (dimensions.autoRotate !== undefined) {
                    document.getElementById('auto-rotate').checked = dimensions.autoRotate;
                }
                
                updateRegionDimensions();
            }
        }
        
        // استخراج النص من المناطق المحددة مع محاولات متعددة
        async function extractFromRegions(base64) {
            // الحصول على قيم المناطق الحالية
            const qTop = document.getElementById('q-top').value;
            const qLeft = document.getElementById('q-left').value;
            const qWidth = document.getElementById('q-width').value;
            const qHeight = document.getElementById('q-height').value;
            
            const oTop = document.getElementById('o-top').value;
            const oLeft = document.getElementById('o-left').value;
            const oWidth = document.getElementById('o-width').value;
            const oHeight = document.getElementById('o-height').value;
            
            // تحسين الصورة أولاً
            const enhancedImage = await enhanceImage(base64);
            
            // محاولة استخراج النص مع تحسينات مختلفة
            let questionText = '';
            let optionsText = '';
            let success = false;
            
            // المحاولة الأولى: مع التحسينات
            try {
                const questionCrop = await cropImage(enhancedImage, qLeft, qTop, qWidth, qHeight);
                questionText = await sendToOCR(questionCrop);
                
                const optionsCrop = await cropImage(enhancedImage, oLeft, oTop, oWidth, oHeight);
                optionsText = await sendToOCR(optionsCrop);
                
                if (questionText.trim().length > 0 && optionsText.trim().length > 0) {
                    success = true;
                }
            } catch (e) {
                console.log('المحاولة الأولى فشلت:', e);
            }
            
            // المحاولة الثانية: بدون تحسينات
            if (!success) {
                try {
                    const questionCrop = await cropImage(base64, qLeft, qTop, qWidth, qHeight);
                    questionText = await sendToOCR(questionCrop);
                    
                    const optionsCrop = await cropImage(base64, oLeft, oTop, oWidth, oHeight);
                    optionsText = await sendToOCR(optionsCrop);
                    
                    if (questionText.trim().length > 0 && optionsText.trim().length > 0) {
                        success = true;
                    }
                } catch (e) {
                    console.log('المحاولة الثانية فشلت:', e);
                }
            }
            
            // المحاولة الثالثة: مع مناطق أكبر قليلاً
            if (!success) {
                try {
                    const questionCrop = await cropImage(base64, 
                        Math.max(0, qLeft - 2), 
                        Math.max(0, qTop - 2), 
                        Math.min(100, qWidth + 4), 
                        Math.min(100, qHeight + 4));
                    questionText = await sendToOCR(questionCrop);
                    
                    const optionsCrop = await cropImage(base64, 
                        Math.max(0, oLeft - 2), 
                        Math.max(0, oTop - 2), 
                        Math.min(100, oWidth + 4), 
                        Math.min(100, oHeight + 4));
                    optionsText = await sendToOCR(optionsCrop);
                    
                    if (questionText.trim().length > 0 && optionsText.trim().length > 0) {
                        success = true;
                    }
                } catch (e) {
                    console.log('المحاولة الثالثة فشلت:', e);
                }
            }
            
            // تقسيم الخيارات إلى أسطر
            const options = optionsText.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0)
                .slice(0, 4); // أخذ أول 4 خيارات فقط
            
            return {
                question: questionText.trim(),
                options: options,
                success: success
            };
        }
        
        /* استدعاء OCR مع تحسينات */
        async function sendToOCR(b64, mime='image/jpeg'){
            const fd=new FormData();
            fd.append('apikey',OCR_KEY);
            fd.append('base64Image',`data:${mime};base64,${b64}`);
            fd.append('language','ara'); 
            fd.append('isOverlayRequired','false');
            fd.append('scale','true'); // محاولة تحسين الدقة
            fd.append('OCREngine','2'); // استخدام محرك OCR الأحدث
            
            const r=await fetch('https://api.ocr.space/parse/image',{method:'POST',body:fd});
            const j=await r.json();
            
            if(!j.ParsedResults?.[0]) {
                // محاولة مع محرك آخر
                fd.set('OCREngine', '1');
                const r2=await fetch('https://api.ocr.space/parse/image',{method:'POST',body:fd});
                const j2=await r2.json();
                if(!j2.ParsedResults?.[0]) throw new Error('لم يتم التعرف على أي نص');
                return j2.ParsedResults[0].ParsedText || '';
            }
            
            return j.ParsedResults[0].ParsedText || '';
        }
        
        /* استدعاء Llama */
        async function sendToHF(prompt){
            const r=await fetch('https://router.huggingface.co/v1/chat/completions',{
                method:'POST',
                headers:{'Content-Type':'application/json','Authorization':`Bearer ${HF_TOKEN}`},
                body:JSON.stringify({
                    model:'meta-llama/Meta-Llama-3-8B-Instruct:groq',
                    messages:[
                        {role:'system',content:'أجب فقط بالاختيار الصحيح أو كلمة مختصرة جداً بدون شرح.'},
                        {role:'user',content:prompt}
                    ],
                    max_tokens:50,temperature:0
                })
            });
            const d=await r.json();
            return d.choices?.[0]?.message?.content?.trim()||'—';
        }
        /* التبويبات */
        function switchTab(tab){
            ['camera','upload','screen'].forEach(t=>{
                document.getElementById(`${t}-tab`).classList.toggle('tab-active',t===tab);
                document.getElementById(`${t}-content`).classList.toggle('hidden',t!==tab);
            });
            if(tab!=='camera') stopCamera();
            if(tab==='screen') {
                checkScreenPermission();
            } else if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
            }
        }
        /* الكاميرا */
        async function startCamera(){
            if (isLocalFile) {
                document.getElementById('camera-status').innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> لا يمكن الوصول للكاميرا من ملف محلي. يرجى استخدام خادم محلي.';
                return;
            }
            
            try{
                const video=document.getElementById('camera-feed');
                cameraStream=await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
                video.srcObject=cameraStream;
                document.getElementById('start-camera').classList.add('hidden');
                document.getElementById('scan-btn').classList.remove('hidden');
                document.getElementById('stop-camera').classList.remove('hidden');
                document.getElementById('camera-status').innerHTML='<i class="fas fa-check-circle text-green-400 mr-2"></i> الكاميرا تعمل الآن - اضغط على "مسح السؤال" لالتقاط السؤال';
            }catch(e){
                document.getElementById('camera-status').innerHTML='<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> لا يمكن الوصول للكاميرا';
            }
        }
        function stopCamera(){
            if(cameraStream){cameraStream.getTracks().forEach(t=>t.stop());cameraStream=null;}
            document.getElementById('camera-feed').srcObject=null;
            document.getElementById('start-camera').classList.remove('hidden');
            document.getElementById('scan-btn').classList.add('hidden');
            document.getElementById('stop-camera').classList.add('hidden');
            document.getElementById('camera-status').innerHTML='<i class="fas fa-info-circle text-blue-400 mr-2"></i> الكاميرا متوقفة';
        }
        /* مسح السؤال */
        async function scanQuestion(){
            const status=document.getElementById('camera-status');
            status.innerHTML='<div class="loading-spinner"></div> جاري تحليل السؤال...';
            
            try{
                const b64=captureFrame(document.getElementById('camera-feed'));
                const {question, options, success} = await extractFromRegions(b64);
                
                if (!success || (!question || options.length === 0)) {
                    throw new Error('لم يتم التعرف على النص بشكل واضح. حاول تحسين إضاءة الصورة أو تثبيت الكاميرا.');
                }
                
                const prompt = question + "\n" + options.join("\n");
                const answer=await sendToHF(prompt);
                displayAnswer({question, options, answer, explanation:''});
                status.innerHTML='<i class="fas fa-check-circle text-green-400 mr-2"></i> تم العثور على إجابة';
            }catch(err){
                status.innerHTML=`<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> ${err.message}`;
            }
        }
        /* الرفع */
        function handleFileUpload(e){
            const file=e.target.files[0]; if(!file) return;
            if(file.size>5*1024*1024){
                document.getElementById('upload-status').innerHTML='<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> الملف أكبر من 5MB';
                return;
            }
            const reader=new FileReader();
            reader.onload=evt=>{
                document.getElementById('preview-image').src=evt.target.result;
                document.getElementById('upload-preview').classList.remove('hidden');
                document.getElementById('solve-btn').classList.remove('hidden');
                document.getElementById('upload-status').innerHTML='<i class="fas fa-check-circle text-green-400 mr-2"></i> تم تحميل الصورة بنجاح';
            };
            reader.readAsDataURL(file);
        }
        async function solveUploadedQuestion(){
            const status=document.getElementById('upload-status');
            status.innerHTML='<div class="loading-spinner"></div> جاري تحليل السؤال...';
            const file=document.getElementById('file-input').files[0];
            if(!file){status.textContent='لم يتم اختيار ملف';return;}
            try{
                const b64=await fileToBase64(file);
                const {question, options, success} = await extractFromRegions(b64);
                
                if (!success || (!question || options.length === 0)) {
                    throw new Error('لم يتم التعرف على النص بشكل واضح. حاول استخدام صورة أفضل أو تفعيل خيارات التحسين.');
                }
                
                const prompt = question + "\n" + options.join("\n");
                const answer=await sendToHF(prompt);
                displayAnswer({question, options, answer, explanation:''});
                status.innerHTML='<i class="fas fa-check-circle text-green-400 mr-2"></i> تم حل السؤال بنجاح';
            }catch(err){
                status.innerHTML=`<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> ${err.message}`;
            }
        }
        
        /* التحقق من أذونات التقاط الشاشة */
        async function checkScreenPermission() {
            const indicator = document.getElementById('screen-permission-indicator');
            const text = document.getElementById('screen-permission-text');
            const requestBtn = document.getElementById('request-screen-btn');
            const startBtn = document.getElementById('start-screen-capture');
            const errorMessage = document.getElementById('screen-error-message');
            
            // التحقق من دعم واجهة برمجة تطبيقات التقاط الشاشة
            if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                indicator.className = 'status-indicator status-denied';
                text.textContent = 'غير مدعوم';
                requestBtn.disabled = true;
                startBtn.disabled = true;
                errorMessage.classList.remove('hidden');
                return;
            }
            
            // التحقق إذا كان الملف محلياً
            if (isLocalFile) {
                indicator.className = 'status-indicator status-denied';
                text.textContent = 'ملف محلي';
                requestBtn.disabled = true;
                startBtn.disabled = true;
                errorMessage.classList.remove('hidden');
                return;
            }
            
            // محاولة طلب الإذن للتحقق من الحالة
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' },
                    audio: false
                });
                
                // إذا نجح الطلب، فهذا يعني أن الإذن ممنوح
                stream.getTracks().forEach(track => track.stop());
                
                indicator.className = 'status-indicator status-granted';
                text.textContent = 'ممنوح';
                requestBtn.disabled = true;
                startBtn.disabled = false;
                errorMessage.classList.add('hidden');
                screenPermissionGranted = true;
                
            } catch (err) {
                // إذا فشل الطلب، قد يكون الإذن مرفوضاً
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    indicator.className = 'status-indicator status-denied';
                    text.textContent = 'مرفوض';
                    requestBtn.disabled = false;
                    startBtn.disabled = true;
                    errorMessage.classList.remove('hidden');
                    screenPermissionGranted = false;
                } else {
                    indicator.className = 'status-indicator status-pending';
                    text.textContent = 'غير معروف';
                    requestBtn.disabled = false;
                    startBtn.disabled = true;
                    screenPermissionGranted = false;
                }
            }
        }
        
        // طلب إذن التقاط الشاشة
        async function requestScreenPermission() {
            if (isLocalFile) {
                showNotification('لا يمكن طلب الإذن من ملف محلي. يرجى استخدام خادم محلي.', 'error');
                return;
            }
            
            const indicator = document.getElementById('screen-permission-indicator');
            const text = document.getElementById('screen-permission-text');
            const requestBtn = document.getElementById('request-screen-btn');
            const startBtn = document.getElementById('start-screen-capture');
            const errorMessage = document.getElementById('screen-error-message');
            
            requestBtn.disabled = true;
            indicator.className = 'status-indicator status-pending';
            text.textContent = 'جاري الطلب...';
            
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' },
                    audio: false
                });
                
                // إذا نجح الطلب، فهذا يعني أن الإذن ممنوح
                stream.getTracks().forEach(track => track.stop());
                
                indicator.className = 'status-indicator status-granted';
                text.textContent = 'ممنوح';
                requestBtn.disabled = true;
                startBtn.disabled = false;
                errorMessage.classList.add('hidden');
                screenPermissionGranted = true;
                
                showNotification('تم منح إذن التقاط الشاشة بنجاح!', 'success');
                
            } catch (err) {
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    indicator.className = 'status-indicator status-denied';
                    text.textContent = 'مرفوض';
                    requestBtn.disabled = false;
                    startBtn.disabled = true;
                    errorMessage.classList.remove('hidden');
                    screenPermissionGranted = false;
                    
                    showNotification('تم رفض إذن التقاط الشاشة. يرجى المحاولة مرة أخرى.', 'error');
                } else {
                    indicator.className = 'status-indicator status-pending';
                    text.textContent = 'خطأ';
                    requestBtn.disabled = false;
                    startBtn.disabled = true;
                    screenPermissionGranted = false;
                    
                    showNotification('حدث خطأ أثناء طلب الإذن: ' + err.message, 'error');
                }
            }
        }
        
        /* التقاط الشاشة */
        async function startScreenCapture() {
            if (isLocalFile) {
                document.getElementById('screen-status').innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> لا يمكن التقاط الشاشة من ملف محلي. يرجى استخدام خادم محلي.';
                return;
            }
            
            const status = document.getElementById('screen-status');
            status.innerHTML = '<div class="loading-spinner"></div> جاري بدء التقاط الشاشة...';
            
            try {
                // طلب إذن المستخدم وبدء التقاط الشاشة
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' },
                    audio: false
                });
                
                status.innerHTML = '<i class="fas fa-check-circle text-green-400 mr-2"></i> جاري التقاط الشاشة...';
                
                // إنشاء عنصر فيديو مؤقت لعرض الشاشة
                const video = document.createElement('video');
                video.srcObject = screenStream;
                video.onloadedmetadata = () => {
                    video.play();
                    
                    // انتظر قليلاً ثم التقط الإطار
                    setTimeout(() => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // تحويل الصورة إلى base64
                        const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
                        
                        // إيقاف تدفق الشاشة
                        screenStream.getTracks().forEach(track => track.stop());
                        screenStream = null;
                        
                        // معالجة الصورة
                        processScreenCapture(base64);
                    }, 1000);
                };
                
                // التعامل مع حالة إيقاف المستخدم للتقاط الشاشة
                screenStream.getVideoTracks()[0].onended = () => {
                    screenStream = null;
                    status.innerHTML = '<i class="fas fa-info-circle text-blue-400 mr-2"></i> تم إيقاف التقاط الشاشة';
                };
                
            } catch (err) {
                status.innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> ${err.message}`;
            }
        }
        
        // معالجة صورة الشاشة الملتقطة
        async function processScreenCapture(base64) {
            const status = document.getElementById('screen-status');
            status.innerHTML = '<div class="loading-spinner"></div> جاري تحليل السؤال...';
            
            try {
                const {question, options, success} = await extractFromRegions(base64);
                
                if (!success || (!question || options.length === 0)) {
                    throw new Error('لم يتم التعرف على النص بشكل واضح. حاول التقاط صورة أوضح أو تفعيل خيارات التحسين.');
                }
                
                const prompt = question + "\n" + options.join("\n");
                const answer = await sendToHF(prompt);
                displayAnswer({question, options, answer, explanation: ''});
                status.innerHTML = '<i class="fas fa-check-circle text-green-400 mr-2"></i> تم حل السؤال بنجاح';
            } catch (err) {
                status.innerHTML = `<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> ${err.message}`;
            }
        }
        
        /* التقاط الشاشة السريع من الأيقونة العائمة */
        async function quickScreenCapture() {
            if (isLocalFile) {
                showNotification('لا يمكن التقاط الشاشة من ملف محلي. يرجى استخدام خادم محلي.', 'error');
                return;
            }
            
            // إظهار شريط التقدم
            showProgress();
            
            try {
                // طلب إذن المستخدم وبدء التقاط الشاشة
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { mediaSource: 'screen' },
                    audio: false
                });
                
                updateProgress(25);
                
                // إنشاء عنصر فيديو مؤقت لعرض الشاشة
                const video = document.createElement('video');
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    
                    // انتظر قليلاً ثم التقط الإطار
                    setTimeout(() => {
                        const canvas = document.createElement('canvas');
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        
                        // تحويل الصورة إلى base64
                        const base64 = canvas.toDataURL('image/jpeg').split(',')[1];
                        
                        // إيقاف تدفق الشاشة
                        stream.getTracks().forEach(track => track.stop());
                        
                        updateProgress(50);
                        
                        // معالجة الصورة والحصول على الإجابة
                        processQuickCapture(base64);
                    }, 800);
                };
                
                // التعامل مع حالة إيقاف المستخدم للتقاط الشاشة
                stream.getVideoTracks()[0].onended = () => {
                    hideProgress();
                    showNotification('تم إيقاف التقاط الشاشة', 'info');
                };
                
            } catch (err) {
                hideProgress();
                showNotification(`خطأ: ${err.message}`, 'error');
            }
        }
        
        // معالجة التقاط الشاشة السريع
        async function processQuickCapture(base64) {
            try {
                updateProgress(60);
                
                const {question, options, success} = await extractFromRegions(base64);
                
                if (!success || (!question || options.length === 0)) {
                    throw new Error('لم يتم التعرف على النص بشكل واضح.');
                }
                
                updateProgress(80);
                
                const prompt = question + "\n" + options.join("\n");
                const answer = await sendToHF(prompt);
                
                updateProgress(100);
                
                // إظهار الإجابة السريعة
                showQuickAnswer(answer);
                
                // إظهار تأثير النجاح
                showSuccessAnimation();
                
                // نسخ الإجابة تلقائياً
                navigator.clipboard.writeText(answer).then(() => {
                    showNotification('تم نسخ الإجابة تلقائياً!', 'success');
                });
                
                // إخفاء شريط التقدم بعد فترة
                setTimeout(() => {
                    hideProgress();
                }, 500);
                
            } catch (err) {
                hideProgress();
                showQuickAnswer(`خطأ: ${err.message}`);
            }
        }
        
        // إظهار شريط التقدم
        function showProgress() {
            const progressBar = document.getElementById('progress-bar');
            const progressFill = document.getElementById('progress-fill');
            
            progressBar.classList.add('active');
            progressFill.style.width = '0%';
        }
        
        // تحديث شريط التقدم
        function updateProgress(percent) {
            const progressFill = document.getElementById('progress-fill');
            progressFill.style.width = percent + '%';
        }
        
        // إخفاء شريط التقدم
        function hideProgress() {
            const progressBar = document.getElementById('progress-bar');
            setTimeout(() => {
                progressBar.classList.remove('active');
            }, 300);
        }
        
        // إظهار الإجابة السريعة
        function showQuickAnswer(answer) {
            const modal = document.getElementById('quick-answer-modal');
            const loading = document.getElementById('quick-answer-loading');
            const text = document.getElementById('quick-answer-text');
            
            // إخفاء التحميل وإظهار النص
            loading.style.display = 'none';
            text.style.display = 'block';
            text.textContent = answer;
            
            // إظهار النافذة
            modal.classList.add('active');
            
            // إغلاق تلقائي بعد 10 ثواني
            clearTimeout(quickAnswerTimeout);
            quickAnswerTimeout = setTimeout(() => {
                closeQuickAnswer();
            }, 10000);
        }
        
        // إغلاق نافذة الإجابة السريعة
        function closeQuickAnswer() {
            const modal = document.getElementById('quick-answer-modal');
            const loading = document.getElementById('quick-answer-loading');
            const text = document.getElementById('quick-answer-text');
            
            modal.classList.remove('active');
            
            // إعادة تعيين المحتوى
            loading.style.display = 'flex';
            text.style.display = 'none';
            text.textContent = '';
            
            clearTimeout(quickAnswerTimeout);
        }
        
        // نسخ الإجابة السريعة
        function copyQuickAnswer() {
            const text = document.getElementById('quick-answer-text').textContent;
            navigator.clipboard.writeText(text).then(() => {
                showNotification('تم نسخ الإجابة!', 'success');
            });
        }
        
        // إظهار تأثير النجاح
        function showSuccessAnimation() {
            const animation = document.getElementById('success-animation');
            animation.classList.add('active');
            
            setTimeout(() => {
                animation.classList.remove('active');
            }, 600);
        }
        
        /* عرض الإجابة */
        function displayAnswer(data){
            currentAnswer=data.answer;
            const answerSection=document.getElementById('answer-section');
            const answerContent=document.getElementById('answer-content');
            
            // تحديد الخيار الصحيح
            let correctOptionIndex = -1;
            data.options.forEach((option, index) => {
                if(option.includes(data.answer)) {
                    correctOptionIndex = index;
                }
            });
            
            answerContent.innerHTML=`
                <div class="mb-6 p-6 bg-white bg-opacity-20 rounded-xl">
                    <h4 class="text-lg font-semibold mb-3 text-center">السؤال:</h4>
                    <p class="text-center text-xl font-medium">${data.question}</p>
                </div>
                <div class="mb-6">
                    <h4 class="text-lg font-semibold mb-4 text-center">الخيارات:</h4>
                    <div class="grid grid-cols-2 gap-4">
                        ${data.options.map((o, i) => `
                            <div class="option-box ${i === correctOptionIndex ? 'correct' : ''}">
                                <span>${o}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="p-4 bg-yellow-500 bg-opacity-20 rounded-xl text-center">
                    <h4 class="text-lg font-semibold mb-2">الإجابة الصحيحة:</h4>
                    <p class="text-2xl font-bold text-yellow-300">${data.answer}</p>
                </div>`;
            
            answerSection.classList.remove('hidden');
            setTimeout(()=>answerSection.querySelector('.answer-card').classList.add('show'),100);
        }
        /* مسح الإجابة */
        function resetAnswer() {
            document.getElementById('answer-section').classList.add('hidden');
            document.getElementById('answer-content').innerHTML = '';
            currentAnswer = '';
        }
        /* نسخ / مشاركة */
        function copyAnswer(){navigator.clipboard.writeText(currentAnswer).then(()=>showNotification('تم نسخ الإجابة!','success'));}
        function shareAnswer(){
            if(navigator.share) navigator.share({title:'إجابة السؤال',text:`الإجابة الصحيحة هي: ${currentAnswer}`})
                .then(()=>showNotification('تمت المشاركة بنجاح!','success'))
                .catch(()=>showNotification('تم إلغاء المشاركة','info'));
            else showNotification('المشاركة غير مدعومة','error');
        }
        
        /* فتح إعدادات المتصفح */
        function openBrowserSettings() {
            // محاولة فتح إعدادات الموقع في Chrome
            if (window.chrome && window.chrome.runtime) {
                // محاولة فتح إعدادات الامتدادات
                window.open('chrome://settings/content/capture', '_blank');
            } else {
                // بديل: فتح صفحة المساعدة
                window.open('https://support.google.com/chrome/answer/2693747', '_blank');
            }
        }
        
        /* إشعارات */
        function showNotification(msg,type){
            const n=document.createElement('div');
            n.className=`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 fade-in ${type==='success'?'bg-green-500':type==='error'?'bg-red-500':'bg-blue-500'} text-white`;
            n.innerHTML=`<div class="flex items-center"><i class="fas ${type==='success'?'fa-check-circle':type==='error'?'fa-exclamation-triangle':'fa-info-circle'} mr-2"></i>${msg}</div>`;
            document.body.appendChild(n);
            setTimeout(()=>{n.style.opacity='0';setTimeout(()=>n.remove(),300);},3000);
        }
        /* التهيئة */
        document.addEventListener('DOMContentLoaded',()=>{
            document.getElementById('year').textContent=new Date().getFullYear();
            
            // التحقق إذا كان الملف محلياً
            if (window.location.protocol === 'file:') {
                isLocalFile = true;
                document.getElementById('local-file-warning').classList.remove('hidden');
                
                // تعطيل الأزرار المتعلقة بالكاميرا والتقاط الشاشة
                document.getElementById('start-camera').disabled = true;
                document.getElementById('start-screen-capture').disabled = true;
                
                showNotification('يتم تشغيل التطبيق من ملف محلي. بعض الميزات معطلة.', 'error');
            }
            
            if(!navigator.mediaDevices?.getUserMedia){
                document.getElementById('camera-status').innerHTML='<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> الكاميرا غير مدعومة في متصفحك';
                document.getElementById('start-camera').disabled=true;
            }
            
            // تحميل الإعدادات المحفوظة
            loadDimensions();
            
            const uploadArea=document.getElementById('upload-area');
            uploadArea.addEventListener('dragover',e=>{e.preventDefault();uploadArea.classList.add('dragover');});
            uploadArea.addEventListener('dragleave',()=>uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop',e=>{
                e.preventDefault();uploadArea.classList.remove('dragover');
                if(e.dataTransfer.files.length){
                    document.getElementById('file-input').files=e.dataTransfer.files;
                    handleFileUpload({target:{files:e.dataTransfer.files}});
                }
            });
            
            // التحقق من دعم تقاط الشاشة عند تحميل الصفحة
            if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                // لا نتحقق من الإذن تلقائياً، بل ننتظر حتى يضغط المستخدم على التبويب
            } else {
                document.getElementById('screen-status').innerHTML = '<i class="fas fa-exclamation-triangle text-yellow-400 mr-2"></i> متصفحك لا يدعم ميزة التقاط الشاشة';
                document.getElementById('start-screen-capture').disabled = true;
            }
        });
    </script>
</body>
</html>